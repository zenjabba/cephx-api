version: '3.8'

# Production Docker Compose configuration
# This extends the base docker-compose.yml with production-specific settings

services:
  ceph-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE}
        - VCS_REF=${VCS_REF}
        - VERSION=${VERSION}

    image: ceph-api:${VERSION:-latest}

    container_name: ceph-api-prod

    # Production network configuration
    networks:
      - ceph-network

    ports:
      - "10.10.2.20:8080:8080"

    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=warning
      - DATABASE_PATH=/opt/ceph-api/data
      - CEPH_CONF=/etc/ceph/ceph.conf
      - CEPH_KEYRING=/etc/ceph/ceph.client.admin.keyring
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - API_WORKERS=8
      - ENVIRONMENT=production

    volumes:
      - /etc/ceph:/etc/ceph:ro
      - /opt/ceph-api/data:/opt/ceph-api/data
      - /opt/ceph-api/config:/opt/ceph-api/config:ro
      - /var/log/ceph-api:/var/log/ceph-api

    restart: always

    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
        labels: "service=ceph-api,environment=production"

    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default

    cap_drop:
      - ALL

    cap_add:
      - NET_BIND_SERVICE

    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /run:noexec,nosuid,size=50m

    # Only allow specific syscalls
    sysctls:
      - net.ipv4.ip_unprivileged_port_start=0

networks:
  ceph-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
    driver_opts:
      com.docker.network.bridge.name: br-ceph-api
